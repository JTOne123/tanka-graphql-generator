<?xml version="1.0" encoding="utf-8"?>

<Project
  xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask AssemblyFile="$(TankaSchemaTaskAssembly)" TaskName="SchemaGenerator" />

  <ItemGroup>
    <PropertyPageSchema Include="$(MSBuildThisFileDirectory)tanka.graphql.generator.xaml">
      <Context>File;BrowseObject</Context>
    </PropertyPageSchema>
    <PropertyPageSchema Include="$(MSBuildThisFileDirectory)graphql.xaml">
      <Context>File;BrowseObject</Context>
    </PropertyPageSchema>

    <AvailableItemName Include="GraphQL" />
  </ItemGroup>

  <ItemDefinitionGroup>
    <GraphQL>
      <Generator>MSBuild:GenerateGraphQL</Generator>
      <Code>%(RelativeDir)%(Filename).g.cs</Code>
      <Generate>Complete</Generate>
    </GraphQL>
  </ItemDefinitionGroup>

  <PropertyGroup>
    <GenerateGraphQLDependsOn>
      $(GenerateGraphQLDependsOn);
      BeforeGenerateGraphQL;
    </GenerateGraphQLDependsOn>
  </PropertyGroup>

  <Target Name="BeforeGenerateGraphQL">
    <PropertyGroup>
      <CodeGenerationRoot Condition="'$(CodeGenerationRoot)' == ''">$(MSBuildProjectDirectory)\$(IntermediateOutputPath)</CodeGenerationRoot>
    </PropertyGroup>
    <ItemGroup>
      <GraphQL Update="@(GraphQL)">
        <Code>$(CodeGenerationRoot)%(Code)</Code>
      </GraphQL>
      <GraphQL Remove="@(GraphQL)" Condition=" %(Generate) =='None' " />
    </ItemGroup>
  </Target>

  <Target
    Name="GenerateGraphQLCode"
    DependsOnTargets="$(GenerateGraphQLCodeDependsOn)"
    Condition="'@(GraphQL)' != ''">
    <SchemaGenerator
      Command="$(TankaGeneratorToolCommand)"
      CommandArgs="$(TankaGeneratorToolCommandArgs)"
      InputFiles="@(GraphQL)"
      RootNamespace="$(RootNamespace)"
      Force="$(TankaGeneratorForce)">
      <Output TaskParameter="OutputFiles" ItemName="SchemaCode" />
    </SchemaGenerator>
    <ItemGroup>
      <Compile Include="@(SchemaCode)" />
      <!-- Extend to be cleaned on clean-->
      <FileWrites Include="@(SchemaCode)" />

      <SourceFilesProjectOutputGroupOutput Include="@(GraphQL->'%(FullPath)')" />
    </ItemGroup>
  </Target>

  <PropertyGroup>
    <GenerateGraphQLDependsOn>
      $(GenerateGraphQLDependsOn);
      BeforeGenerateGraphQL;
      GenerateGraphQLCode
    </GenerateGraphQLDependsOn>
  </PropertyGroup>

  <Target Name="GenerateGraphQL"
          DependsOnTargets="$(GenerateGraphQLDependsOn)"
          BeforeTargets="CoreCompile">
  </Target>
</Project>