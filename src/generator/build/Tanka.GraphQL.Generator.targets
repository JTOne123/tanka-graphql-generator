<?xml version="1.0" encoding="utf-8" ?>
<Project
	xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<UsingTask AssemblyFile="$(TankaSchemaTaskAssembly)" TaskName="SchemaGenerator"/>

	<ItemGroup>
		<PropertyPageSchema Include="$(MSBuildThisFileDirectory)Tanka.GraphQL.Generator.xaml" />
		<PropertyPageSchema Include="$(MSBuildThisFileDirectory)Tanka.GraphQL.Generator.ContentType.xaml" />
    <AvailableItemName Include="TankaSchema"/>
	</ItemGroup>

  <PropertyGroup>
    <GenerateTankaSchemaDependsOn>
      $(GenerateTankaSchemaDependsOn);
      BeforeGenerateTankaSchema;
    </GenerateTankaSchemaDependsOn>		
  </PropertyGroup>
  <Target Name="BeforeGenerateTankaSchema">
    <PropertyGroup>
      <CodeGenerationRoot Condition="'$(CodeGenerationRoot)' == ''">$(MSBuildProjectDirectory)\$(IntermediateOutputPath)</CodeGenerationRoot>
    </PropertyGroup>
    <ItemGroup>
      <TankaSchema Update="@(TankaSchema)">
        <Code>$(CodeGenerationRoot)%(Code)</Code>
      </TankaSchema>
    </ItemGroup>
  </Target>

  <Target 
		Name="GenerateTankaSchemaCode" 
    DependsOnTargets="$(GenerateTankaSchemaCodeDependsOn)"
    Condition="'@(TankaSchema)' != ''">
    <SchemaGenerator
      Command="$(TankaGeneratorToolCommand)"
      CommandArgs="$(TankaGeneratorToolCommandArgs)"
      InputFiles="@(TankaSchema)"
      RootNamespace="$(RootNamespace)"
      Force="$(TankaGeneratorForce)">
			<Output TaskParameter="OutputFiles" ItemName="SchemaCode"/>
    </SchemaGenerator>
    <ItemGroup>
      <Compile Include="@(SchemaCode)"/>
      <!-- Extend to be cleaned on clean-->
      <FileWrites Include="@(SchemaCode)" />
    </ItemGroup>
  </Target>

  <PropertyGroup>
    <GenerateTankaSchemaDependsOn>
      $(GenerateTankaSchemaDependsOn);
      BeforeGenerateTankaSchema;
      GenerateTankaSchemaCode
    </GenerateTankaSchemaDependsOn>		
  </PropertyGroup>

  <Target Name="GenerateTankaSchema"
          DependsOnTargets="$(GenerateTankaSchemaDependsOn)"
          BeforeTargets="CoreCompile;PrepareResources">
  </Target>
</Project>