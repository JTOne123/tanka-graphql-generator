<?xml version="1.0" encoding="utf-8" ?>
<Project
	xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<UsingTask AssemblyFile="$(TankaSchemaTaskAssembly)" TaskName="SchemaGenerator"/>

	<ItemGroup>
		<PropertyPageSchema Include="$(MSBuildThisFileDirectory)Tanka.GraphQL.Generator.xaml" />
		<PropertyPageSchema Include="$(MSBuildThisFileDirectory)Tanka.GraphQL.Generator.ContentType.xaml" />
    <AvailableItemName Include="TankaSchema"/>
	</ItemGroup>

  <Target Name="BeforeGenerateTankaSchema">
    <PropertyGroup>
      <CodeGenerationRoot Condition="'$(CodeGenerationRoot)' == ''">$(MSBuildProjectDirectory)\$(IntermediateOutputPath)</CodeGenerationRoot>
    </PropertyGroup>
    <Message Text="CodeGenerationRoot: $(CodeGenerationRoot)" Importance="High"/>
    <ItemGroup>
      <TankaSchema Update="@(TankaSchema)">
        <Code>$(CodeGenerationRoot)%(Code)</Code>
      </TankaSchema>
    </ItemGroup>
  </Target>

	<PropertyGroup>
    <GenerateTankaSchemaDependsOn>
      $(GenerateTankaSchemaDependsOn);
      BeforeGenerateTankaSchema;
    </GenerateTankaSchemaDependsOn>		
  </PropertyGroup>
  <Target 
		Name="GenerateTankaSchema" 
		BeforeTargets="CoreCompile;PrepareResources"
    DependsOnTargets="BeforeGenerateTankaSchema"
    Condition="'@(TankaSchema)' != ''"
    Inputs="@(TankaSchema)"
    Outputs="@(TankaSchema -> '%(Code)')"
	>
    <SchemaGenerator
      Command="$(TankaGeneratorToolCommand)"
      CommandArgs="$(TankaGeneratorToolCommandArgs)"
      InputFiles="@(TankaSchema)"
      RootNamespace="$(RootNamespace)"
		>
			<Output TaskParameter="OutputFiles" ItemName="SchemaCode"/>
    </SchemaGenerator>
    <ItemGroup>
			<Compile Include="@(SchemaCode)"/>
		</ItemGroup>
		
	</Target>

</Project>